---
title: "Krefeld-Schwalb reproduction"
format: html
---

# Introduction

We're reproducing some data from Krefeld-Schwalb et al. (2024), "Exposing omitted moderators: Explaining why effect sizes differ in the social sciences." 
We're going to look only at Study 1A, and focus on the sunk cost judgment task.

OSF repo: https://osf.io/7kqg9/files

```{r}
library(tidyverse)
library(here)
library(janitor)
library(metafor)
d <- read_csv(here("data","Study1A_prepared.csv"))
```
First let's learn about the dataset. 

> In Study 1a, we tested four paradigms on eight online panels (detailed information can be found in SI Appendix, section 1.1): The default effect [organ donation (47)], the framing effect [unusual disease (48)], the less-is-better effect (49), and the sunk cost effect (50). We collected demographic variables (gender, age, income, and political orientation), Crystallized Intelligence (education, age), Fluid Intelligence (the cognitive reflection task and numeracy (31, 32), Experience with each paradigm and online research in general, and measures of Attentiveness (response times), as well as two attention checks. In addition to panels that are ubiquitous in academic research (MTurk, Cloud Research, and Prolific), we used commercial providers that vary in quality (four distinct panels and a blended panel from Lucid Marketplace).

Let's use the `janitor` package to clean up. 

```{r}
d <- janitor::clean_names(d)
```

```{r}
names(d)
```
```{r}
unique(d$panel)
```

Let's start with the sunk cost stimuli:

> Imagine that your favorite football team is playing an important game. You have a ticket to the game that you have paid handsomely for. However, on the day of the game, it happens to be freezing cold. What do you do?

```{r}
sunk_means <- d |>
  group_by(panel, sunk_condition) |>
  summarise(sunk_cost_mean = mean(num_sunk_cost), 
            n = n(), 
            sem = sd(num_sunk_cost) / sqrt(n), 
            ci_lower = sunk_cost_mean - 1.96 * sem,
            ci_upper = sunk_cost_mean + 1.96 * sem)

```

Now let's make a nice plot of site variation.

```{r}
ggplot(sunk_means, aes(x = panel, y = sunk_cost_mean, col = sunk_condition)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width = .1)) + 
  coord_flip() + 
  ggthemes::theme_few() + 
  ggthemes::scale_color_solarized() + 
  labs(x = "Panel",
       y = "Sunk Cost Rating (1-9)", 
       col = "Condition")
```
There is indeed heterogeneity!


# Participant level analysis

Let's start by looking at the participant level. First we'll look at the CRT and BNT as moderators.  

My hypothesis is that the BNT is the Berlin numeracy test. 

```{r}
ggplot(d, aes(x = crt_score, y = num_sunk_cost, col = sunk_condition)) + 
  geom_jitter(alpha = .2, size = 1) +
  geom_smooth(method = "lm") + 
  facet_wrap(vars(panel)) +
  ggthemes::theme_few() + 
  ggthemes::scale_color_solarized() + 
  labs(x = "CRT score",
       y = "Sunk Cost Rating (1-9)", 
       col = "Condition")
```

```{r}
ggplot(d, aes(x = bnt, y = num_sunk_cost, col = sunk_condition)) + 
  geom_jitter(alpha = .2, size = 1) +
  geom_smooth(method = "lm") + 
  facet_wrap(vars(panel)) +
  ggthemes::theme_few() + 
  ggthemes::scale_color_solarized() + 
  labs(x = "BNT score",
       y = "Sunk Cost Rating (1-9)", 
       col = "Condition")
```

# Panel-level analysis

The approach that's taken in the paper is to explain panel variation by average panel differences. 


```{r}
sunk_effect <- d |>
  group_by(panel) |>
  summarise(m1i = mean(num_sunk_cost[sunk_condition == "FREE"]), 
            m2i = mean(num_sunk_cost[sunk_condition == "PAID"]), 
            sd1i = sd(num_sunk_cost[sunk_condition == "FREE"]),
            sd2i = sd(num_sunk_cost[sunk_condition == "PAID"]), 
            n1i = sum(sunk_condition == "FREE"),
            n2i = sum(sunk_condition == "PAID"),
            crt_mean = mean(crt_score),
            bnt_mean = mean(bnt),
            ed_mean = mean(num_edu))

sunk_effect <- summary(metafor::escalc(data = sunk_effect, measure = "SMD", 
                                   m1i = m1i, m2i = m2i, 
                                   sd1i = sd1i, sd2i = sd2i, 
                                   n1i = n1i, n2i = n2i))
```

Here's an effect size plot. 

```{r}
ggplot(sunk_effect, aes(x = crt_mean, y = yi)) + 
  geom_pointrange(aes(ymin = ci.lb, ymax = ci.ub)) +
  ggthemes::theme_few() + 
  ggthemes::scale_color_solarized() + 
  labs(x = "CRT score",
       y = "Sunk Cost Rating (1-9)")
```

How would we make this figure across multiple moderators? 

```{r}
...
```

